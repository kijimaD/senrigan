# Senrigan - 監視カメラシステム

## 機能要件

### フェーズ1: リアルタイム再生（現在の実装対象）
- 複数の定点カメラで、ブラウザからリアルタイム再生できる（保存はしない）
- 低遅延でのストリーミング配信
- 複数カメラの同時表示

### フェーズ2: タイムラプス機能
- 数秒ごとにタイムラプス画像を保存しており、ブラウザ/アプリで任意時点にジャンプ、ズーム・パン操作可能
  - サムネイル＋タイムスタンプ管理で一覧表示
  - コンビニなどの監視カメラのUIのイメージ。カーソルを動かすと、それぞれの定点カメラの時系列が遡る

### フェーズ3: 動画生成
- 一定期間ごとにタイムラプス画像を使って、タイムラプス動画を生成する

## アーキテクチャ設計

### 全体方針
- **段階的な実装**: まずモノリシックで開始し、必要に応じてハイブリッド構成へ移行
- **将来の拡張性を考慮**: インターフェースを適切に設計し、後からの機能追加を容易に
- **シンプルさ優先**: 過度な抽象化を避け、必要最小限の実装から開始

### フェーズ1の設計（現在）

#### 技術スタック
- **言語**: Go
- **ストリーミング方式**: WebSocket + MJPEG
  - 理由: シンプルで実装が容易、ブラウザ互換性が高い、遅延が少ない
- **Webフレームワーク**: 標準ライブラリ (net/http) + gorilla/websocket
- **カメラ入力**: V4L2 (Video4Linux2) または FFmpeg経由

#### システム構成
```
[カメラ] → [Goサーバー] → [WebSocket] → [ブラウザ]
```

#### プロジェクト構造
```
senrigan/
├── cmd/
│   └── server/
│       └── main.go          # エントリーポイント
├── internal/
│   ├── camera/              # カメラ制御・キャプチャ
│   │   ├── doc.go          
│   │   ├── manager.go      # 複数カメラの管理
│   │   ├── capture.go      # カメラからの画像取得
│   │   └── stream.go       # ストリーム生成
│   ├── server/              # HTTPサーバー
│   │   ├── doc.go          
│   │   ├── server.go       # HTTPサーバー本体
│   │   ├── websocket.go    # WebSocketハンドラ
│   │   └── static.go       # 静的ファイル配信
│   └── config/              # 設定管理
│       ├── doc.go          
│       └── config.go       # 設定構造体
├── web/                     # フロントエンド
│   ├── index.html          # メインページ
│   ├── style.css           # スタイル
│   └── app.js              # WebSocket接続・表示制御
├── go.mod
├── go.sum
├── Makefile
├── README.md
└── config.yaml              # 設定ファイル
```

#### 主要コンポーネント

1. **Camera Manager**
   - 複数カメラの管理
   - カメラの初期化・終了処理
   - フレームレートの制御

2. **Stream Handler**
   - カメラからの画像をJPEGにエンコード
   - WebSocketクライアントへの配信
   - バックプレッシャー制御

3. **WebSocket Server**
   - クライアント接続管理
   - ストリームのルーティング
   - 切断処理

### 将来のハイブリッド構成への移行パス

フェーズ2以降で必要に応じて以下の分離を検討：

1. **ストリーミングサーバー** (現在のコア)
   - リアルタイム配信に特化
   - 軽量・低遅延を維持

2. **ストレージサービス** (フェーズ2で追加)
   - タイムラプス画像の保存
   - メタデータ管理
   - サムネイル生成

3. **ワーカープロセス** (フェーズ3で追加)
   - 動画生成処理
   - バッチ処理

## 実装の優先順位

1. 単一カメラのストリーミング実装
2. 複数カメラ対応
3. Web UIの改善
4. 設定ファイル対応
5. エラーハンドリング・ロギング強化

## 非機能要件

- **遅延**: 1秒以内のストリーミング遅延
- **同時接続数**: 10クライアント程度を想定
- **画質**: 720p (1280x720) @ 15-30fps
- **カメラ数**: 最大4台程度
